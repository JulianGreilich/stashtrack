<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StashTrack - Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Cpath%20d%3D%22M50%202%20C%2020%2010%2C%2010%2040%2C%2050%2098%20C%2090%2040%2C%2080%2010%2C%2050%202%20Z%22%20fill%3D%22%232d3748%22%2F%3E%3Cpolyline%20points%3D%2225%2C70%2045%2C50%2060%2C60%2075%2C45%22%20fill%3D%22none%22%20stroke%3D%22%23e53e3e%22%20stroke-width%3D%228%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3Cpath%20d%3D%22M75%2045%20L%2067%2050%20M%2075%2045%20L%2067%2040%22%20stroke%3D%22%23e53e3e%22%20stroke-width%3D%228%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3Cpath%20d%3D%22M50%208%20C%2041.16%2C8%2034%2C15.16%2034%2C24%20C%2034%2C35.48%2050%2C52%2050%2C52%20C%2050%2C52%2066%2C35.48%2066%2C24%20C%2066%2C15.16%2058.84%2C8%2050%2C8%20Z%22%20fill%3D%22%23e53e3e%22%2F%3E%3Ccircle%20cx%3D%2250%22%20cy%3D%2224%22%20r%3D%226%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-appearance: textfield;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="container mx-auto max-w-lg p-4 min-h-screen">
        
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-slate-700">StashTrack</h1>
            <p class="text-slate-500 mt-1">Track anything you have in stock.</p>
        </header>

        <!-- Summary Chart -->
        <div id="summaryChartContainer" class="bg-white p-4 sm:p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Inventory Outlook</h2>
            <div class="relative h-64">
                <canvas id="summaryChart"></canvas>
            </div>
        </div>

        <!-- Alert Banner for low stock items -->
        <div id="alertBanner" class="hidden bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded-md mb-6" role="alert">
            <p class="font-bold">Heads up!</p>
            <p id="alertBannerText"></p>
        </div>

        <div id="loading" class="text-center my-8"><p class="text-slate-500">Loading inventory...</p></div>
        <div id="inventoryList" class="space-y-4"></div>
        <div id="emptyState" class="hidden text-center my-16 bg-slate-100 p-8 rounded-lg">
            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <h3 class="mt-2 text-sm font-medium text-slate-800">No items in inventory</h3>
            <p class="mt-1 text-sm text-slate-500">Get started by adding a new item below.</p>
        </div>

        <!-- Form to Add New Items -->
        <div class="bg-white p-6 rounded-xl shadow-md my-8">
            <h2 class="text-xl font-semibold mb-4">Add New Item</h2>
            <form id="addItemForm" class="space-y-4">
                <div>
                    <label for="itemName" class="block text-sm font-medium text-slate-600">Item Name</label>
                    <input type="text" id="itemName" name="itemName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Coffee Beans, AA Batteries">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="itemQuantity" class="block text-sm font-medium text-slate-600">Initial Quantity</label>
                        <input type="number" id="itemQuantity" name="itemQuantity" required min="0" step="0.1" class="no-spinner mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 50 or 10.5">
                    </div>
                    <div>
                        <label for="itemDuration" class="block text-sm font-medium text-slate-600">Duration (Days)</label>
                        <input type="number" id="itemDuration" name="itemDuration" min="0" step="0.1" class="no-spinner mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Optional">
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Add Item
                </button>
            </form>
        </div>
        
        <footer class="text-center text-xs text-slate-400 mt-12 pb-4">
            <p>Your User ID (for data persistence):</p>
            <p id="userId" class="font-mono break-all"></p>
        </footer>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="historyModalTitle">Usage History</h3>
                <button id="closeModal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="historyModalBody" class="p-4">
                <!-- Canvas is now dynamically added here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, serverTimestamp, getDocs, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This is your unique configuration object from your Firebase project.
        // It is required for the live version on GitHub to connect to your database.
        const firebaseConfig = {
          apiKey: "AIzaSyAKYZ-RQz-ry6kE89dpn0DCHc-wOx1lexs",
          authDomain: "my-stashtrack-app.firebaseapp.com",
          projectId: "my-stashtrack-app",
          storageBucket: "my-stashtrack-app.appspot.com",
          messagingSenderId: "123421812523",
          appId: "1:123421812523:web:3760831a567bf658c0476e"
        };
        const appId = firebaseConfig.projectId;
        const initialAuthToken = null;

        let db, auth, userId, inventoryCollection;
        
        const ui = {
            addItemForm: document.getElementById('addItemForm'),
            inventoryList: document.getElementById('inventoryList'),
            loadingDiv: document.getElementById('loading'),
            emptyStateDiv: document.getElementById('emptyState'),
            userIdDisplay: document.getElementById('userId'),
            alertBanner: document.getElementById('alertBanner'),
            alertBannerText: document.getElementById('alertBannerText'),
            summaryChartContainer: document.getElementById('summaryChartContainer'),
            summaryChartCanvas: document.getElementById('summaryChart'),
            historyModal: {
                el: document.getElementById('historyModal'),
                title: document.getElementById('historyModalTitle'),
                body: document.getElementById('historyModalBody'),
                closeBtn: document.getElementById('closeModal'),
            }
        };
        let historyChart = null;
        let summaryChart = null;

        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
                else { await signInAnonymously(auth); }
                
                userId = auth.currentUser.uid;
                ui.userIdDisplay.textContent = userId;

                const collectionPath = `artifacts/${appId}/users/${userId}/inventory`;
                inventoryCollection = collection(db, collectionPath);
                
                listenForInventoryChanges();
                setupEventListeners();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                if (error.code === 'auth/requests-from-referer-are-blocked') {
                    ui.loadingDiv.innerHTML = `
                        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md text-left">
                            <p class="font-bold">Authentication Error!</p>
                            <p class="text-sm mt-2">Firebase is blocking requests from this website's address. This is a security feature.</p>
                            <p class="text-xs mt-3 text-slate-600"><b>To fix this:</b></p>
                            <ol class="list-decimal list-inside text-xs text-slate-600 mt-1">
                                <li>Go to the <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-600 underline">Google Cloud Console API Credentials</a> page.</li>
                                <li>Find your API key, click the pencil icon to edit it.</li>
                                <li>Under "Application restrictions", select "Websites" and add your GitHub Pages URL (e.g., <code>https://your-username.github.io/stashtrack/*</code>) to the list of allowed referrers.</li>
                                <li>To use this preview, you may need to temporarily select "Don't restrict key".</li>
                            </ol>
                        </div>
                    `;
                } else {
                    ui.loadingDiv.textContent = "Error loading app. Please check console.";
                }
            }
        }

        function listenForInventoryChanges() {
            const q = query(inventoryCollection);
            onSnapshot(q, async (snapshot) => {
                const itemPromises = snapshot.docs.map(async (doc) => {
                    const item = { id: doc.id, ...doc.data() };
                    const stats = await calculateStats(item.id, item.duration);
                    return { ...item, ...stats };
                });

                const itemsWithStats = await Promise.all(itemPromises);
                itemsWithStats.sort((a, b) => a.name.localeCompare(b.name));
                renderInventory(itemsWithStats);
                renderSummaryChart(itemsWithStats);
            }, (error) => {
                console.error("Error fetching inventory:", error);
                ui.loadingDiv.textContent = "Failed to load inventory.";
            });
        }
        
        async function logChange(itemId, changeAmount, currentQuantity) {
             if (changeAmount === 0) return;
             const historyCollection = collection(db, inventoryCollection.path, itemId, 'history');
             await addDoc(historyCollection, {
                 change: changeAmount,
                 timestamp: serverTimestamp(),
                 quantityAfter: currentQuantity + changeAmount
             });
        }


        async function updateQuantity(itemId, change) {
            const itemRef = doc(db, inventoryCollection.path, itemId);
            const currentItem = ui.inventoryList.querySelector(`[data-id="${itemId}"]`);
            if (!currentItem) return;
            const currentQuantityStr = currentItem.querySelector('.item-quantity-value').textContent.replace(/,/g, '');
            const currentQuantity = parseFloat(currentQuantityStr);
            const newQuantity = Math.max(0, currentQuantity + change);
            
            try {
                await updateDoc(itemRef, { quantity: newQuantity });
                await logChange(itemId, newQuantity - currentQuantity, currentQuantity);
            } catch (error) { console.error("Error updating quantity:", error); }
        }

        async function setQuantity(itemId, newQuantityStr) {
            const newQuantity = Math.max(0, parseFloat(newQuantityStr));
            if (isNaN(newQuantity)) return;
            
            const itemRef = doc(db, inventoryCollection.path, itemId);
            const currentItem = ui.inventoryList.querySelector(`[data-id="${itemId}"]`);
            if (!currentItem) return;
            const currentQuantityStr = currentItem.querySelector('.item-quantity-value').textContent.replace(/,/g, '');
            const currentQuantity = parseFloat(currentQuantityStr);
            
            try {
                await updateDoc(itemRef, { quantity: newQuantity });
                await logChange(itemId, newQuantity - currentQuantity, currentQuantity);
            } catch (error) { console.error("Error setting quantity:", error); }
        }

        async function calculateStats(itemId, normalDuration) {
            if (normalDuration) {
                return { runRate: parseFloat(normalDuration) };
            }

            const historyCollection = collection(db, inventoryCollection.path, itemId, 'history');
            const q = query(historyCollection, orderBy('timestamp', 'asc'));
            const snapshot = await getDocs(q);

            const consumptions = snapshot.docs
                .map(doc => ({ ...doc.data(), id: doc.id }))
                .filter(log => log.change < 0 && log.timestamp)
                .map(log => ({
                    units: Math.abs(log.change),
                    date: log.timestamp.toDate()
                }));

            if (consumptions.length < 1) { return { runRate: null }; }

            if (consumptions.length === 1) {
                const firstEvent = snapshot.docs[0]?.data();
                if (!firstEvent || !firstEvent.timestamp) return { runRate: null };
                const timeDiffMs = consumptions[0].date.getTime() - firstEvent.timestamp.toDate().getTime();
                const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);
                const unitsConsumed = consumptions[0].units;
                if (timeDiffDays > 0 && unitsConsumed > 0) { return { runRate: timeDiffDays / unitsConsumed }; }
                return { runRate: null };
            }

            const firstConsumption = consumptions[0];
            const lastConsumption = consumptions[consumptions.length - 1];
            const totalUnitsConsumed = consumptions.reduce((sum, event) => sum + event.units, 0);
            if (totalUnitsConsumed <= 0) { return { runRate: null }; }
            const timeDiffMs = lastConsumption.date.getTime() - firstConsumption.date.getTime();
            const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);
            const unitsForAvg = totalUnitsConsumed - lastConsumption.units;
            if (timeDiffDays > 0 && unitsForAvg > 0) { return { runRate: timeDiffDays / unitsForAvg }; }
            return { runRate: null }; 
        }

        function renderSummaryChart(items) {
            const chartData = items
                .filter(item => item.runRate && item.quantity > 0)
                .map(item => ({
                    name: item.name,
                    remainingDays: item.quantity * item.runRate
                }))
                .sort((a, b) => a.remainingDays - b.remainingDays); 

            if (summaryChart) {
                summaryChart.destroy();
            }

            if (chartData.length === 0) {
                ui.summaryChartContainer.classList.add('hidden');
                return;
            }
            ui.summaryChartContainer.classList.remove('hidden');

            const labels = chartData.map(d => d.name);
            const data = chartData.map(d => d.remainingDays);
            const colors = data.map(days => {
                if (days <= 14) return 'rgba(239, 68, 68, 0.8)';
                if (days <= 28) return 'rgba(245, 158, 11, 0.8)';
                return 'rgba(34, 197, 94, 0.8)';
            });

            summaryChart = new Chart(ui.summaryChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Days Remaining',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Est. ${context.raw.toFixed(1)} days remaining`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Estimated Days Remaining' }
                        }
                    }
                }
            });
        }


        function renderInventory(items) {
            ui.loadingDiv.classList.add('hidden');
            ui.inventoryList.innerHTML = ''; 

            const twoWeeksFromNow = new Date();
            twoWeeksFromNow.setDate(new Date().getDate() + 14);
            
            let lowStockCount = 0;

            if (items.length === 0) {
                ui.emptyStateDiv.classList.remove('hidden');
            } else {
                ui.emptyStateDiv.classList.add('hidden');
                items.forEach(item => {
                    const el = document.createElement('div');
                    
                    let depletionDate = null;
                    let depletionText = 'N/A';
                    let isRunningLow = false;

                    if (item.runRate && item.quantity > 0) {
                        depletionDate = new Date();
                        depletionDate.setDate(depletionDate.getDate() + (item.quantity * item.runRate));
                        depletionText = depletionDate.toLocaleDateString();
                        if (depletionDate <= twoWeeksFromNow) {
                           isRunningLow = true;
                           lowStockCount++;
                        }
                    } else if (item.runRate && item.quantity <= 0) {
                        depletionText = 'Empty';
                    }

                    el.className = `p-4 rounded-lg shadow-sm fade-in transition-colors ${isRunningLow ? 'bg-amber-50 border-2 border-amber-300' : 'bg-white'}`;
                    el.dataset.id = item.id;

                    el.innerHTML = `
                        <div class="flex items-center justify-between">
                             <p class="font-semibold text-lg flex items-center">
                                ${item.name}
                                ${isRunningLow ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>' : ''}
                            </p>
                            <button data-action="delete" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full flex items-center justify-center transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div class="item-quantity-display bg-slate-50 p-2 rounded-md text-center cursor-pointer hover:bg-slate-100 flex flex-col justify-center">
                                <p class="text-xs text-slate-500">Current Count</p>
                                <p class="text-2xl font-bold text-slate-800 item-quantity-value">${Number(item.quantity).toLocaleString()}</p>
                            </div>
                            <div class="grid grid-cols-3 gap-1.5 text-sm">
                                <button data-action="increase-10" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 rounded-md">+10</button>
                                <button data-action="increase-1" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-md">+1</button>
                                <button data-action="increase-0.1" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 rounded-md">+0.1</button>
                                <button data-action="decrease-10" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 rounded-md">-10</button>
                                <button data-action="decrease-1" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 rounded-md">-1</button>
                                <button data-action="decrease-0.1" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 rounded-md">-0.1</button>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-100 grid grid-cols-3 gap-2 text-center text-xs">
                             <div>
                                <p class="text-slate-500">Est. Run Rate</p>
                                <p class="font-medium">${item.runRate ? `${item.runRate.toFixed(1)} days/unit` : 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">Est. Empty On</p>
                                <p class="font-medium">${depletionText}</p>
                            </div>
                            <div>
                                <button data-action="history" data-name="${item.name}" data-quantity="${item.quantity}" class="text-blue-600 hover:underline w-full h-full">View History</button>
                            </div>
                        </div>
                    `;
                    ui.inventoryList.appendChild(el);
                });
            }

            if (lowStockCount > 0) {
                ui.alertBannerText.textContent = `${lowStockCount} item${lowStockCount > 1 ? 's are' : ' is'} estimated to run out within two weeks.`;
                ui.alertBanner.classList.remove('hidden');
            } else {
                ui.alertBanner.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            ui.addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = e.target.itemName.value.trim();
                const quantity = parseFloat(e.target.itemQuantity.value);
                const duration = e.target.itemDuration.value.trim();
                if (name && !isNaN(quantity) && quantity >= 0) {
                    const docRef = await addDoc(inventoryCollection, { name, quantity, duration: duration || null });
                    await logChange(docRef.id, quantity, 0);
                    ui.addItemForm.reset();
                }
            });

            ui.inventoryList.addEventListener('click', (e) => {
                const target = e.target;
                const button = target.closest('button');
                const quantityDisplay = target.closest('.item-quantity-display');
                const itemElement = target.closest('[data-id]');
                if (!itemElement) return;
                const itemId = itemElement.dataset.id;
                
                if (button) {
                    const action = button.dataset.action;
                    if (action === 'increase-1') updateQuantity(itemId, 1);
                    else if (action === 'decrease-1') updateQuantity(itemId, -1);
                    else if (action === 'increase-10') updateQuantity(itemId, 10);
                    else if (action === 'decrease-10') updateQuantity(itemId, -10);
                    else if (action === 'increase-0.1') updateQuantity(itemId, 0.1);
                    else if (action === 'decrease-0.1') updateQuantity(itemId, -0.1);
                    else if (action === 'delete') deleteDoc(doc(db, inventoryCollection.path, itemId));
                    else if (action === 'history') showHistoryModal(itemId, button.dataset.name, button.dataset.quantity);
                } else if (quantityDisplay) {
                    handleQuantityOverwrite(quantityDisplay, itemId);
                }
            });

            ui.historyModal.closeBtn.addEventListener('click', () => ui.historyModal.el.classList.add('hidden'));
            ui.historyModal.el.addEventListener('click', (e) => {
                if (e.target === ui.historyModal.el) ui.historyModal.el.classList.add('hidden');
            });
        }
        
        function handleQuantityOverwrite(displayElement, itemId) {
            const valueElement = displayElement.querySelector('.item-quantity-value');
            const originalValue = valueElement.textContent.replace(/,/g, '');
            
            const input = document.createElement('input');
            input.type = 'number';
            input.step = "0.1";
            input.className = 'no-spinner text-2xl font-bold text-slate-800 bg-transparent w-full text-center outline-none';
            input.value = originalValue;
            
            displayElement.replaceChild(input, valueElement);
            input.focus();
            input.select();
            
            const saveOrRevert = () => {
                const newValue = input.value;
                input.removeEventListener('blur', saveOrRevert);
                input.removeEventListener('keydown', handleKeydown);

                if (newValue !== originalValue) {
                    setQuantity(itemId, newValue);
                } else {
                    displayElement.replaceChild(valueElement, input);
                }
            };

            const handleKeydown = (e) => {
                if (e.key === 'Enter') {
                    saveOrRevert();
                } else if (e.key === 'Escape') {
                    input.removeEventListener('blur', saveOrRevert);
                    input.removeEventListener('keydown', handleKeydown);
                    displayElement.replaceChild(valueElement, input);
                }
            };
            
            input.addEventListener('blur', saveOrRevert);
            input.addEventListener('keydown', handleKeydown);
        }

        async function showHistoryModal(itemId, itemName, currentQuantity) {
            ui.historyModal.title.textContent = `History for ${itemName}`;
            
            if (historyChart) {
                historyChart.destroy();
                historyChart = null;
            }
            
            const canvasContainer = ui.historyModal.body;
            canvasContainer.innerHTML = '';

            const historyCol = collection(db, inventoryCollection.path, itemId, 'history');
            const q = query(historyCol, orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                canvasContainer.innerHTML = '<p class="text-center text-slate-500">No history recorded for this item yet.</p>';
            } else {
                const canvas = document.createElement('canvas');
                canvas.id = 'historyChart';
                canvasContainer.appendChild(canvas);

                const labels = [];
                const data = [];
                let runningQuantity = parseFloat(currentQuantity);
                labels.unshift('Now');
                data.unshift(runningQuantity);

                snapshot.docs.forEach(doc => {
                    const log = doc.data();
                    if (log.timestamp) {
                        const date = log.timestamp.toDate();
                        const prevQuantity = runningQuantity - log.change;
                        labels.unshift(date.toLocaleDateString());
                        data.unshift(prevQuantity);
                        runningQuantity = prevQuantity;
                    }
                });

                historyChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Stock Level',
                            data: data,
                            fill: true,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.1,
                            stepped: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            ui.historyModal.el.classList.remove('hidden');
        }
        
        main();
    </script>
</body>
</html>

