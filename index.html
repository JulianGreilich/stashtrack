<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StashTrack - Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Cpath%20d%3D%22M50%202%20C%2020%2010%2C%2010%2040%2C%2050%2098%20C%2090%2040%2C%2080%2010%2C%2050%202%20Z%22%20fill%3D%22%232d3748%22%2F%3E%3Cpolyline%20points%3D%2225%2C70%2045%2C50%2060%2C60%2075%2C45%22%20fill%3D%22none%22%20stroke%3D%22%23e53e3e%22%20stroke-width%3D%228%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3Cpath%20d%3D%22M75%2045%20L%2067%2050%20M%2075%2045%20L%2067%2040%22%20stroke%3D%22%23e53e3e%22%20stroke-width%3D%228%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3Cpath%20d%3D%22M50%208%20C%2041.16%2C8%2034%2C15.16%2034%2C24%20C%2034%2C35.48%2050%2C52%2050%2C52%20C%2050%2C52%2066%2C35.48%2066%2C24%20C%2066%2C15.16%2058.84%2C8%2050%2C8%20Z%22%20fill%3D%22%23e53e3e%22%2F%3E%3Ccircle%20cx%3D%2250%22%20cy%3D%2224%22%20r%3D%226%22%20fill%3D%22white%22%2F%3E%3C%2Fsvg%3E">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-appearance: textfield;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .category-filter-btn.active {
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="container mx-auto max-w-lg p-4 min-h-screen">
        
        <header class="flex justify-between items-center my-6">
            <div class="text-left">
                <h1 class="text-3xl font-bold text-slate-700">StashTrack</h1>
                <p class="text-slate-500 mt-1">Track anything you have in stock.</p>
            </div>
            <button id="openAddItemModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1.5 px-3 text-sm rounded-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span>Add Item</span>
            </button>
        </header>

        <!-- Summary Chart -->
        <div id="summaryChartContainer" class="bg-white p-4 sm:p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Inventory Outlook</h2>
            <div class="relative h-64">
                <canvas id="summaryChart"></canvas>
            </div>
        </div>

        <!-- Alert Banner for low stock items -->
        <div id="alertBanner" class="hidden bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded-md mb-6" role="alert">
            <p class="font-bold">Heads up!</p>
            <p id="alertBannerText"></p>
        </div>
        
        <!-- Category Filters -->
        <div id="category-filters-container" class="mb-4">
            <h3 class="text-sm font-medium text-slate-600 mb-2">Filter by Category:</h3>
            <div id="category-filters" class="flex flex-wrap gap-2">
                <!-- Filter buttons will be inserted here -->
            </div>
        </div>

        <div id="loading" class="text-center my-8"><p class="text-slate-500">Loading inventory...</p></div>
        <div id="inventoryList" class="space-y-2"></div>
        <div id="emptyState" class="hidden text-center my-16 bg-slate-100 p-8 rounded-lg">
            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <h3 class="mt-2 text-sm font-medium text-slate-800">No items in inventory</h3>
            <p class="mt-1 text-sm text-slate-500">Get started by adding a new item.</p>
        </div>
        
        <footer class="text-center text-xs text-slate-400 mt-12 pb-4">
            <p>Your User ID (for data persistence):</p>
            <p id="userId" class="font-mono break-all"></p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="addItemModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Add New Item</h3>
                <button data-action="close-modal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4">
                <form id="addItemForm" class="space-y-4">
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-slate-600">Item Name</label>
                        <input type="text" id="itemName" name="itemName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Coffee Beans, AA Batteries">
                    </div>
                    <div id="category-selection-container">
                        <label for="itemCategory" class="block text-sm font-medium text-slate-600">Category</label>
                        <select id="itemCategory" name="itemCategory" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options will be populated by JS -->
                        </select>
                    </div>
                     <div id="new-category-container" class="hidden">
                        <label for="newCategoryName" class="block text-sm font-medium text-slate-600">New Category Name</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="text" id="newCategoryName" name="newCategoryName" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <button type="button" id="cancelNewCategory" class="text-sm text-slate-500 hover:text-slate-700">Cancel</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="itemQuantity" class="block text-sm font-medium text-slate-600">Initial Quantity</label>
                            <input type="number" id="itemQuantity" name="itemQuantity" required min="0" step="0.1" class="no-spinner mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 50 or 10.5">
                        </div>
                        <div>
                            <label for="itemDuration" class="block text-sm font-medium text-slate-600">Duration (Days)</label>
                            <input type="number" id="itemDuration" name="itemDuration" min="0" step="0.1" class="no-spinner mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Optional">
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="itemDailyUse" name="itemDailyUse" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="itemDailyUse" class="ml-2 block text-sm text-gray-900">Enable daily use tracking</label>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">
                        Add Item
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="historyModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="historyModalTitle">Usage History</h3>
                <button data-action="close-modal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="historyModalBody" class="p-4"></div>
        </div>
    </div>

    <div id="editItemModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Edit Item</h3>
                <button data-action="close-modal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-4">
                <form id="editItemForm" class="space-y-4"></form>
            </div>
        </div>
    </div>

    <div id="adjustStashModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-sm m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="adjustStashModalTitle">Adjust Stash</h3>
                <button data-action="close-modal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="adjustStashModalBody" class="p-4 grid grid-cols-2 gap-2">
                <!-- Adjust stash buttons will be inserted here -->
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, serverTimestamp, getDocs, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAKYZ-RQz-ry6kE89dpn0DCHc-wOx1lexs",
          authDomain: "my-stashtrack-app.firebaseapp.com",
          projectId: "my-stashtrack-app",
          storageBucket: "my-stashtrack-app.appspot.com",
          messagingSenderId: "123421812523",
          appId: "1:123421812523:web:3760831a567bf658c0476e"
        };
        const appId = firebaseConfig.projectId;
        const initialAuthToken = null;

        // Register the plugin globally for all charts
        Chart.register(ChartDataLabels);

        let db, auth, userId, inventoryCollection, categoriesCollection;
        let allItems = [];
        let categories = [];
        let currentCategoryFilter = 'all';
        
        const ui = {
            addItemForm: document.getElementById('addItemForm'),
            inventoryList: document.getElementById('inventoryList'),
            loadingDiv: document.getElementById('loading'),
            emptyStateDiv: document.getElementById('emptyState'),
            userIdDisplay: document.getElementById('userId'),
            alertBanner: document.getElementById('alertBanner'),
            alertBannerText: document.getElementById('alertBannerText'),
            summaryChartContainer: document.getElementById('summaryChartContainer'),
            summaryChartCanvas: document.getElementById('summaryChart'),
            categoryFilters: document.getElementById('category-filters'),
            itemCategorySelect: document.getElementById('itemCategory'),
            newCategoryContainer: document.getElementById('new-category-container'),
            newCategoryNameInput: document.getElementById('newCategoryName'),
            cancelNewCategoryBtn: document.getElementById('cancelNewCategory'),
            addItemModal: document.getElementById('addItemModal'),
            openAddItemModalBtn: document.getElementById('openAddItemModalBtn'),
            historyModal: {
                el: document.getElementById('historyModal'),
                title: document.getElementById('historyModalTitle'),
                body: document.getElementById('historyModalBody'),
            },
            editItemModal: {
                el: document.getElementById('editItemModal'),
                form: document.getElementById('editItemForm'),
            },
            adjustStashModal: {
                el: document.getElementById('adjustStashModal'),
                title: document.getElementById('adjustStashModalTitle'),
                body: document.getElementById('adjustStashModalBody'),
            }
        };
        
        const categoryColors = ['#e0f2fe', '#dcfce7', '#fef9c3', '#fee2e2', '#f5d0fe', '#ede9fe', '#dbeafe', '#cffafe', '#fce7f3', '#fae8ff'];

        function getCategoryColor(categoryName) {
            if (!categoryName) return { bg: '#F1F5F9', text: '#475569' }; // Default slate color
            let hash = 0;
            for (let i = 0; i < categoryName.length; i++) {
                hash = categoryName.charCodeAt(i) + ((hash << 5) - hash);
            }
            hash = Math.abs(hash);
            const colorIndex = hash % categoryColors.length;
            const bgColor = categoryColors[colorIndex];
            const textColor = '#1E293B'; // Dark slate text for better contrast on light backgrounds
            return { bg: bgColor, text: textColor };
        }

        let historyChart = null;
        let summaryChart = null;

        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
                else { await signInAnonymously(auth); }
                
                userId = auth.currentUser.uid;
                ui.userIdDisplay.textContent = userId;

                const basePath = `artifacts/${appId}/users/${userId}`;
                inventoryCollection = collection(db, `${basePath}/inventory`);
                categoriesCollection = collection(db, `${basePath}/categories`);
                
                listenForChanges();
                setupEventListeners();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                ui.loadingDiv.textContent = "Error loading app. Please check console.";
            }
        }

        function listenForChanges() {
            onSnapshot(query(categoriesCollection, orderBy('name')), (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategoryFilters();
                renderCategoryDropdown(ui.itemCategorySelect, { required: true });
            });

            onSnapshot(query(inventoryCollection), async (snapshot) => {
                const itemPromises = snapshot.docs.map(async (doc) => {
                    const item = { id: doc.id, ...doc.data() };
                    const stats = await calculateStats(item.id, item.duration, item.dailyUse);
                    return { ...item, ...stats };
                });
                allItems = await Promise.all(itemPromises);
                renderFilteredInventory();
                renderSummaryChart();
            }, (error) => {
                console.error("Error fetching inventory:", error);
                ui.loadingDiv.textContent = "Failed to load inventory.";
            });
        }
        
        async function logChange(itemId, changeAmount, currentQuantity) {
             if (changeAmount === 0) return;
             const historyCollection = collection(db, inventoryCollection.path, itemId, 'history');
             await addDoc(historyCollection, {
                 change: changeAmount,
                 timestamp: serverTimestamp(),
                 quantityAfter: currentQuantity + changeAmount
             });
        }

        async function updateQuantity(itemId, change) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;
            const itemRef = doc(db, inventoryCollection.path, itemId);
            const newQuantity = Math.max(0, item.quantity + change);
            
            try {
                await updateDoc(itemRef, { quantity: newQuantity });
                await logChange(itemId, newQuantity - item.quantity, item.quantity);
            } catch (error) { console.error("Error updating quantity:", error); }
        }

        async function calculateStats(itemId, normalDuration, dailyUse) {
            if (!dailyUse) return { runRate: null, estimatedQuantity: null };

            const historyCollection = collection(db, inventoryCollection.path, itemId, 'history');
            const q = query(historyCollection, orderBy('timestamp', 'asc'));
            const snapshot = await getDocs(q);

            const allHistory = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));

            const consumptions = allHistory
                .filter(log => log.change < 0 && log.timestamp)
                .map(log => ({
                    units: Math.abs(log.change),
                    date: log.timestamp.toDate()
                }));

            let runRate = null;
            if (consumptions.length > 0) {
                const creationEvent = allHistory[0];
                if (creationEvent && creationEvent.timestamp) {
                    const creationDate = creationEvent.timestamp.toDate();
                    const lastConsumption = consumptions[consumptions.length - 1];
                    const totalUnitsConsumed = consumptions.reduce((sum, event) => sum + event.units, 0);

                    if (totalUnitsConsumed > 0) {
                        const timeDiffMs = lastConsumption.date.getTime() - creationDate.getTime();
                        const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);
                        if (timeDiffDays > 0) {
                            runRate = timeDiffDays / totalUnitsConsumed;
                        }
                    }
                }
            }

            if (!runRate && normalDuration) {
                runRate = parseFloat(normalDuration);
            }

            let estimatedQuantity = null;
            if (runRate && allHistory.length > 0) {
                const lastEvent = allHistory[allHistory.length - 1];
                if (lastEvent && lastEvent.timestamp) {
                    const lastUpdateDate = lastEvent.timestamp.toDate();
                    const now = new Date();
                    const daysSinceLastUpdate = (now.getTime() - lastUpdateDate.getTime()) / (1000 * 60 * 60 * 24);
                    const estimatedConsumption = daysSinceLastUpdate / runRate;
                    estimatedQuantity = Math.max(0, lastEvent.quantityAfter - estimatedConsumption);
                }
            }

            return { runRate, estimatedQuantity };
        }

        function renderFilteredInventory() {
            const itemsToRender = (currentCategoryFilter === 'all')
                ? allItems
                : allItems.filter(item => item.category === currentCategoryFilter);
            
            itemsToRender.sort((a, b) => a.name.localeCompare(b.name));
            renderInventory(itemsToRender);
        }

        function renderCategoryFilters() {
            ui.categoryFilters.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.textContent = 'All';
            allBtn.className = 'category-filter-btn px-3 py-1 text-sm rounded-full border border-slate-300 bg-white hover:bg-slate-100 transition-colors';
            allBtn.dataset.category = 'all';
            if (currentCategoryFilter === 'all') allBtn.classList.add('active');
            ui.categoryFilters.appendChild(allBtn);

            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.textContent = cat.name;
                btn.className = 'category-filter-btn px-3 py-1 text-sm rounded-full border border-slate-300 bg-white hover:bg-slate-100 transition-colors';
                btn.dataset.category = cat.name;
                if (currentCategoryFilter === cat.name) btn.classList.add('active');
                ui.categoryFilters.appendChild(btn);
            });
        }
        
        function renderCategoryDropdown(selectElement, options = { required: false, selected: '' }) {
            selectElement.innerHTML = '';
            if (!options.required) {
                const noChangeOption = document.createElement('option');
                noChangeOption.value = "";
                noChangeOption.textContent = "No Change";
                selectElement.appendChild(noChangeOption);
            } else {
                 const placeholderOption = document.createElement('option');
                placeholderOption.value = "";
                placeholderOption.textContent = "Select a category";
                placeholderOption.disabled = true;
                selectElement.appendChild(placeholderOption);
            }

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                selectElement.appendChild(option);
            });

            const newOption = document.createElement('option');
            newOption.value = "new_category";
            newOption.textContent = "Create New Category...";
            selectElement.appendChild(newOption);
            
            selectElement.value = options.selected || "";
        }

        function renderSummaryChart() {
            const itemsToChart = (currentCategoryFilter === 'all')
                ? allItems
                : allItems.filter(item => item.category === currentCategoryFilter);

            const chartData = itemsToChart
                .filter(item => item.runRate && item.quantity > 0)
                .map(item => {
                    const depletionDate = new Date();
                    depletionDate.setDate(depletionDate.getDate() + (item.quantity * item.runRate));
                    const now = new Date();
                    const remainingMs = depletionDate.getTime() - now.getTime();
                    const remainingDays = Math.max(0, remainingMs / (1000 * 60 * 60 * 24));
                    return { name: item.name, remainingDays: remainingDays };
                })
                .sort((a, b) => a.remainingDays - b.remainingDays); 
            
            if (summaryChart) { summaryChart.destroy(); }
            if (chartData.length === 0) { ui.summaryChartContainer.classList.add('hidden'); return; }
            
            ui.summaryChartContainer.classList.remove('hidden');
            const labels = chartData.map(d => d.name);
            const data = chartData.map(d => d.remainingDays);
            const colors = data.map(days => { if (days <= 14) return 'rgba(239, 68, 68, 0.8)'; if (days <= 28) return 'rgba(245, 158, 11, 0.8)'; return 'rgba(34, 197, 94, 0.8)'; });
            
            const maxDataValue = Math.max(...data);

            summaryChart = new Chart(ui.summaryChartCanvas, { 
                type: 'bar', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Days Remaining', 
                        data: data, 
                        backgroundColor: colors, 
                        borderColor: colors.map(c => c.replace('0.8', '1')), 
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    indexAxis: 'y', 
                    maintainAspectRatio: false, 
                    responsive: true, 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            callbacks: { 
                                label: function(context) { return `Est. ${context.raw.toFixed(1)} days remaining`; } 
                            } 
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            formatter: (value) => Math.round(value),
                            color: '#334155',
                            font: {
                                weight: 'bold',
                                size: 12,
                            }
                        }
                    }, 
                    scales: { 
                        x: { 
                            beginAtZero: true, 
                            max: maxDataValue * 1.1, // Add 10% padding to the x-axis
                            title: { 
                                display: true, 
                                text: 'Estimated Days Remaining' 
                            } 
                        } 
                    } 
                } 
            });
        }

        function renderInventory(items) {
            ui.loadingDiv.classList.add('hidden');
            ui.inventoryList.innerHTML = ''; 
            const twoWeeksFromNow = new Date();
            twoWeeksFromNow.setDate(new Date().getDate() + 14);
            let lowStockCount = 0;

            if (items.length === 0) {
                ui.emptyStateDiv.classList.remove('hidden');
                ui.emptyStateDiv.querySelector('h3').textContent = (currentCategoryFilter === 'all') ? 'No items in inventory' : `No items in category: ${currentCategoryFilter}`;
            } else {
                ui.emptyStateDiv.classList.add('hidden');
                items.forEach(item => {
                    const el = document.createElement('div');
                    let isRunningLow = false;
                    if (item.dailyUse && item.runRate && item.quantity > 0) {
                        const depletionDate = new Date();
                        depletionDate.setDate(depletionDate.getDate() + (item.quantity * item.runRate));
                        if (depletionDate <= twoWeeksFromNow) {
                            isRunningLow = true;
                            lowStockCount++;
                        }
                    }

                    el.className = `p-3 rounded-lg shadow-sm fade-in transition-colors flex items-center justify-between ${isRunningLow ? 'bg-amber-50 border-2 border-amber-300' : 'bg-white'}`;
                    el.dataset.id = item.id;
                    
                    const estimatedQtyText = item.dailyUse && item.estimatedQuantity !== null ? `(${item.estimatedQuantity.toFixed(1)})` : '';
                    const categoryColor = getCategoryColor(item.category);

                    el.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-lg">${item.name}</p>
                             <div class="flex items-center gap-2 mt-1">
                                <p class="text-sm text-slate-600">
                                    ${Number(item.quantity).toLocaleString()} <span class="text-xs text-slate-500">${estimatedQtyText}</span>
                                </p>
                                <p class="text-xs font-medium px-2 py-0.5 rounded-full inline-block" style="background-color: ${categoryColor.bg}; color: ${categoryColor.text};">${item.category || 'Uncategorized'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-1">
                            <button data-action="adjust" class="text-slate-500 hover:text-green-600 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg></button>
                            <button data-action="history" data-name="${item.name}" data-quantity="${item.quantity}" class="text-slate-500 hover:text-blue-600 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3 1a1 1 0 00-1 1v6a1 1 0 102 0V7a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v6a1 1 0 102 0V7a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v6a1 1 0 102 0V7a1 1 0 00-1-1z" /></svg></button>
                            <button data-action="edit" class="text-slate-500 hover:text-blue-600 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button data-action="delete" class="text-slate-500 hover:text-red-600 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>
                    `;
                    ui.inventoryList.appendChild(el);
                });
            }
            if (lowStockCount > 0) { ui.alertBannerText.textContent = `${lowStockCount} item${lowStockCount > 1 ? 's are' : ' is'} estimated to run out within two weeks.`; ui.alertBanner.classList.remove('hidden'); } else { ui.alertBanner.classList.add('hidden'); }
        }

        function setupEventListeners() {
            ui.openAddItemModalBtn.addEventListener('click', () => {
                ui.addItemModal.classList.remove('hidden');
            });

            ui.addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                let category = ui.itemCategorySelect.value;
                const newCategoryName = ui.newCategoryNameInput.value.trim();

                if (category === 'new_category') {
                    if (newCategoryName) {
                        const existingCategory = categories.find(c => c.name.toLowerCase() === newCategoryName.toLowerCase());
                        if (existingCategory) {
                            category = existingCategory.name;
                        } else {
                            await addDoc(categoriesCollection, { name: newCategoryName });
                            category = newCategoryName; 
                        }
                    } else {
                        alert("Please enter a name for the new category.");
                        return;
                    }
                }
                
                if (!category) {
                    alert("Please select a category for the item.");
                    return;
                }

                const name = ui.addItemForm.itemName.value.trim();
                const quantity = parseFloat(ui.addItemForm.itemQuantity.value);
                const duration = ui.addItemForm.itemDuration.value.trim() || null;
                const dailyUse = ui.addItemForm.itemDailyUse.checked;
                
                if (name && !isNaN(quantity) && quantity >= 0) {
                    const docRef = await addDoc(inventoryCollection, { name, quantity, duration, category, dailyUse });
                    await logChange(docRef.id, quantity, 0);
                    ui.addItemForm.reset();
                    ui.newCategoryContainer.classList.add('hidden');
                    ui.itemCategorySelect.classList.remove('hidden');
                    renderCategoryDropdown(ui.itemCategorySelect, { required: true });
                    ui.addItemModal.classList.add('hidden');
                }
            });

            ui.itemCategorySelect.addEventListener('change', () => {
                if (ui.itemCategorySelect.value === 'new_category') {
                    ui.itemCategorySelect.classList.add('hidden');
                    ui.newCategoryContainer.classList.remove('hidden');
                    ui.newCategoryNameInput.focus();
                }
            });

            ui.cancelNewCategoryBtn.addEventListener('click', () => {
                ui.newCategoryContainer.classList.add('hidden');
                ui.itemCategorySelect.classList.remove('hidden');
                ui.newCategoryNameInput.value = '';
                ui.itemCategorySelect.value = '';
            });

            ui.inventoryList.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const itemElement = e.target.closest('[data-id]');
                if (!itemElement) return;
                const itemId = itemElement.dataset.id;
                const action = button.dataset.action;
                
                const actions = {
                    'delete': () => { if(confirm('Are you sure you want to delete this item?')) deleteDoc(doc(db, inventoryCollection.path, itemId)) },
                    'edit': () => showEditModal(itemId),
                    'history': () => showHistoryModal(itemId),
                    'adjust': () => showAdjustStashModal(itemId),
                };

                if (actions[action]) actions[action]();
            });
            
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button && button.dataset.action === 'close-modal') {
                    button.closest('.modal-overlay').classList.add('hidden');
                }
            });

            ui.categoryFilters.addEventListener('click', (e) => {
                const button = e.target.closest('.category-filter-btn');
                if (button) {
                    currentCategoryFilter = button.dataset.category;
                    document.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderFilteredInventory();
                    renderSummaryChart(); // Re-render chart on filter change
                }
            });
        }
        
        function showAdjustStashModal(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;

            ui.adjustStashModal.title.textContent = `Adjust ${item.name}`;
            const body = ui.adjustStashModal.body;
            body.innerHTML = `
                <button data-action="decrease-1" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-3 rounded-md">-1</button>
                <button data-action="decrease-0.1" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-3 rounded-md">-0.1</button>
                <button data-action="increase-1" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-md">+1</button>
                <button data-action="increase-10" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-3 rounded-md">+10</button>
            `;

            body.onclick = (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const action = button.dataset.action;

                const adjustments = {
                    'increase-10': 10, 'increase-1': 1, 'increase-0.1': 0.1,
                    'decrease-1': -1, 'decrease-0.1': -0.1
                };

                if (adjustments[action] !== undefined) {
                    updateQuantity(itemId, adjustments[action]);
                    ui.adjustStashModal.el.classList.add('hidden');
                }
            };
            
            ui.adjustStashModal.el.classList.remove('hidden');
        }

        function showEditModal(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;

            const form = ui.editItemModal.form;
            form.innerHTML = `
                <input type="hidden" name="itemId" value="${item.id}">
                <div>
                    <label for="editItemName" class="block text-sm font-medium text-slate-600">Item Name</label>
                    <input type="text" id="editItemName" name="itemName" required value="${item.name}" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="editItemCategory" class="block text-sm font-medium text-slate-600">Category</label>
                    <select id="editItemCategory" name="itemCategory" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md"></select>
                </div>
                <div id="edit-new-category-container" class="hidden">
                    <label for="editNewCategoryName" class="block text-sm font-medium text-slate-600">New Category Name</label>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="text" id="editNewCategoryName" name="editNewCategoryName" class="block w-full px-3 py-2 bg-white border border-slate-300 rounded-md">
                        <button type="button" id="cancelEditNewCategory" class="text-sm text-slate-500 hover:text-slate-700">Cancel</button>
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editItemQuantity" class="block text-sm font-medium text-slate-600">Quantity</label>
                        <input type="number" id="editItemQuantity" name="itemQuantity" required step="0.1" value="${item.quantity}" class="no-spinner mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md">
                    </div>
                    <div>
                        <label for="editItemDuration" class="block text-sm font-medium text-slate-600">Duration</label>
                        <input type="number" id="editItemDuration" name="itemDuration" step="0.1" value="${item.duration || ''}" class="no-spinner mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md" placeholder="Optional">
                    </div>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="editItemDailyUse" name="itemDailyUse" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${item.dailyUse ? 'checked' : ''}>
                    <label for="editItemDailyUse" class="ml-2 block text-sm text-gray-900">Enable daily use tracking</label>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button type="button" data-action="close-modal" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                </div>
            `;
            
            const editCategorySelect = form.querySelector('#editItemCategory');
            const editNewCategoryContainer = form.querySelector('#edit-new-category-container');
            const editNewCategoryInput = form.querySelector('#editNewCategoryName');
            const cancelEditNewCategoryBtn = form.querySelector('#cancelEditNewCategory');

            renderCategoryDropdown(editCategorySelect, { selected: item.category });

            editCategorySelect.addEventListener('change', () => {
                if (editCategorySelect.value === 'new_category') {
                    editCategorySelect.classList.add('hidden');
                    editNewCategoryContainer.classList.remove('hidden');
                    editNewCategoryInput.focus();
                }
            });
            cancelEditNewCategoryBtn.addEventListener('click', () => {
                editNewCategoryContainer.classList.add('hidden');
                editCategorySelect.classList.remove('hidden');
                editNewCategoryInput.value = '';
                editCategorySelect.value = item.category || '';
            });

            ui.editItemModal.el.classList.remove('hidden');

            form.onsubmit = async (e) => {
                e.preventDefault();
                let category = editCategorySelect.value;
                const newCategoryName = editNewCategoryInput.value.trim();
                
                if (editCategorySelect.value === 'new_category') {
                    if (newCategoryName) {
                        const existingCategory = categories.find(c => c.name.toLowerCase() === newCategoryName.toLowerCase());
                        if (existingCategory) {
                            category = existingCategory.name;
                        } else {
                            await addDoc(categoriesCollection, { name: newCategoryName });
                            category = newCategoryName;
                        }
                    } else {
                        category = item.category;
                    }
                }
                
                const formData = new FormData(form);
                const updates = {
                    name: formData.get('itemName').trim(),
                    category: category,
                    quantity: parseFloat(formData.get('itemQuantity')),
                    duration: formData.get('itemDuration') || null,
                    dailyUse: form.querySelector('#editItemDailyUse').checked
                };
                
                if (updates.name && !isNaN(updates.quantity)) {
                    await updateDoc(doc(db, inventoryCollection.path, itemId), updates);
                    ui.editItemModal.el.classList.add('hidden');
                }
            };
        }

        async function showHistoryModal(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;

            ui.historyModal.title.textContent = `History for ${item.name}`;
            if (historyChart) { historyChart.destroy(); historyChart = null; }
            const canvasContainer = ui.historyModal.body;
            canvasContainer.innerHTML = '';
            const historyCol = collection(db, inventoryCollection.path, itemId, 'history');
            const q = query(historyCol, orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { canvasContainer.innerHTML = '<p class="text-center text-slate-500">No history recorded yet.</p>'; } else {
                const canvas = document.createElement('canvas');
                canvasContainer.appendChild(canvas);
                const labels = []; const data = []; let runningQuantity = parseFloat(item.quantity);
                labels.unshift('Now'); data.unshift(runningQuantity);
                snapshot.docs.forEach(doc => { const log = doc.data(); if (log.timestamp) { const date = log.timestamp.toDate(); const prevQuantity = runningQuantity - log.change; labels.unshift(date.toLocaleDateString()); data.unshift(prevQuantity); runningQuantity = prevQuantity; } });
                historyChart = new Chart(canvas, { type: 'line', data: { labels: labels, datasets: [{ label: 'Stock Level', data: data, fill: true, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.1, stepped: true, }] }, options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false }, datalabels: { display: false } } } });
            }
            ui.historyModal.el.classList.remove('hidden');
        }
        
        main();
    </script>
</body>
</html>

