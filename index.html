<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StashTrack - Inventory Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="data:image/jpeg;base64,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">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-spinner {
            -moz-appearance: textfield;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app-container" class="container mx-auto max-w-lg p-4 min-h-screen">
        
        <header class="text-center my-6">
            <h1 class="text-3xl font-bold text-slate-700">StashTrack</h1>
            <p class="text-slate-500 mt-1">Track anything you have in stock.</p>
        </header>

        <!-- Summary Chart -->
        <div id="summaryChartContainer" class="bg-white p-4 sm:p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Inventory Outlook</h2>
            <div class="relative h-64">
                <canvas id="summaryChart"></canvas>
            </div>
        </div>

        <!-- Alert Banner for low stock items -->
        <div id="alertBanner" class="hidden bg-amber-100 border-l-4 border-amber-500 text-amber-700 p-4 rounded-md mb-6" role="alert">
            <p class="font-bold">Heads up!</p>
            <p id="alertBannerText"></p>
        </div>

        <div id="loading" class="text-center my-8"><p class="text-slate-500">Loading inventory...</p></div>
        <div id="inventoryList" class="space-y-4"></div>
        <div id="emptyState" class="hidden text-center my-16 bg-slate-100 p-8 rounded-lg">
            <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <h3 class="mt-2 text-sm font-medium text-slate-800">No items in inventory</h3>
            <p class="mt-1 text-sm text-slate-500">Get started by adding a new item below.</p>
        </div>

        <!-- Form to Add New Items -->
        <div class="bg-white p-6 rounded-xl shadow-md my-8">
            <h2 class="text-xl font-semibold mb-4">Add New Item</h2>
            <form id="addItemForm" class="space-y-4">
                <div>
                    <label for="itemName" class="block text-sm font-medium text-slate-600">Item Name</label>
                    <input type="text" id="itemName" name="itemName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Coffee Beans, AA Batteries">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="itemQuantity" class="block text-sm font-medium text-slate-600">Initial Quantity</label>
                        <input type="number" id="itemQuantity" name="itemQuantity" required min="0" step="0.1" class="no-spinner mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 50 or 10.5">
                    </div>
                    <div>
                        <label for="itemDuration" class="block text-sm font-medium text-slate-600">Duration (Days)</label>
                        <input type="number" id="itemDuration" name="itemDuration" min="0" step="0.1" class="no-spinner mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Optional">
                    </div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Add Item
                </button>
            </form>
        </div>
        
        <footer class="text-center text-xs text-slate-400 mt-12 pb-4">
            <p>Your User ID (for data persistence):</p>
            <p id="userId" class="font-mono break-all"></p>
        </footer>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md m-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="historyModalTitle">Usage History</h3>
                <button id="closeModal" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="historyModalBody" class="p-4">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, serverTimestamp, getDocs, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DO NOT EDIT ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END DO NOT EDIT ---

        let db, auth, userId, inventoryCollection;
        
        const ui = {
            addItemForm: document.getElementById('addItemForm'),
            inventoryList: document.getElementById('inventoryList'),
            loadingDiv: document.getElementById('loading'),
            emptyStateDiv: document.getElementById('emptyState'),
            userIdDisplay: document.getElementById('userId'),
            alertBanner: document.getElementById('alertBanner'),
            alertBannerText: document.getElementById('alertBannerText'),
            summaryChartContainer: document.getElementById('summaryChartContainer'),
            summaryChartCanvas: document.getElementById('summaryChart'),
            historyModal: {
                el: document.getElementById('historyModal'),
                title: document.getElementById('historyModalTitle'),
                body: document.getElementById('historyModalBody'),
                closeBtn: document.getElementById('closeModal'),
                chartCanvas: document.getElementById('historyChart'),
            }
        };
        let historyChart = null;
        let summaryChart = null;

        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
                else { await signInAnonymously(auth); }
                
                userId = auth.currentUser.uid;
                ui.userIdDisplay.textContent = userId;

                const collectionPath = `artifacts/${appId}/users/${userId}/inventory`;
                inventoryCollection = collection(db, collectionPath);
                
                listenForInventoryChanges();
                setupEventListeners();
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                ui.loadingDiv.textContent = "Error loading app. Please check console.";
            }
        }

        async function listenForInventoryChanges() {
            const q = query(inventoryCollection);
            onSnapshot(q, async (snapshot) => {
                const itemPromises = snapshot.docs.map(async (doc) => {
                    const item = { id: doc.id, ...doc.data() };
                    const stats = await calculateStats(item.id, item.duration);
                    return { ...item, ...stats };
                });

                const itemsWithStats = await Promise.all(itemPromises);
                itemsWithStats.sort((a, b) => a.name.localeCompare(b.name));
                renderInventory(itemsWithStats);
                renderSummaryChart(itemsWithStats);
            }, (error) => {
                console.error("Error fetching inventory:", error);
                ui.loadingDiv.textContent = "Failed to load inventory.";
            });
        }
        
        async function logChange(itemId, changeAmount, currentQuantity) {
             if (changeAmount === 0) return;
             const historyCollection = collection(db, inventoryCollection.path, itemId, 'history');
             await addDoc(historyCollection, {
                 change: changeAmount,
                 timestamp: serverTimestamp(),
                 quantityAfter: currentQuantity + changeAmount
             });
        }


        async function updateQuantity(itemId, change) {
            const itemRef = doc(db, inventoryCollection.path, itemId);
            const currentItem = ui.inventoryList.querySelector(`[data-id="${itemId}"]`);
            if (!currentItem) return;
            const currentQuantity = parseFloat(currentItem.querySelector('.item-quantity-value').textContent);
            const newQuantity = Math.max(0, currentQuantity + change);
            
            try {
                await updateDoc(itemRef, { quantity: newQuantity });
                await logChange(itemId, newQuantity - currentQuantity, currentQuantity);
            } catch (error) { console.error("Error updating quantity:", error); }
        }

        async function setQuantity(itemId, newQuantityStr) {
            const newQuantity = Math.max(0, parseFloat(newQuantityStr));
            if (isNaN(newQuantity)) return;
            
            const itemRef = doc(db, inventoryCollection.path, itemId);
            const currentItem = ui.inventoryList.querySelector(`[data-id="${itemId}"]`);
            if (!currentItem) return;
            const currentQuantity = parseFloat(currentItem.querySelector('.item-quantity-value').textContent);
            
            try {
                await updateDoc(itemRef, { quantity: newQuantity });
                await logChange(itemId, newQuantity - currentQuantity, currentQuantity);
            } catch (error) { console.error("Error setting quantity:", error); }
        }

        async function calculateStats(itemId, normalDuration) {
            if (normalDuration) {
                return { runRate: parseFloat(normalDuration) };
            }

            const historyCollection = collection(db, inventoryCollection.path, itemId, 'history');
            const q = query(historyCollection, orderBy('timestamp', 'asc'));
            const snapshot = await getDocs(q);

            const consumptions = snapshot.docs
                .map(doc => ({ ...doc.data(), id: doc.id }))
                .filter(log => log.change < 0 && log.timestamp)
                .map(log => ({
                    units: Math.abs(log.change),
                    date: log.timestamp.toDate()
                }));

            if (consumptions.length < 1) { return { runRate: null }; }

            if (consumptions.length === 1) {
                const firstEvent = snapshot.docs[0]?.data();
                if (!firstEvent || !firstEvent.timestamp) return { runRate: null };
                const timeDiffMs = consumptions[0].date.getTime() - firstEvent.timestamp.toDate().getTime();
                const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);
                const unitsConsumed = consumptions[0].units;
                if (timeDiffDays > 0 && unitsConsumed > 0) { return { runRate: timeDiffDays / unitsConsumed }; }
                return { runRate: null };
            }

            const firstConsumption = consumptions[0];
            const lastConsumption = consumptions[consumptions.length - 1];
            const totalUnitsConsumed = consumptions.reduce((sum, event) => sum + event.units, 0);
            if (totalUnitsConsumed <= 0) { return { runRate: null }; }
            const timeDiffMs = lastConsumption.date.getTime() - firstConsumption.date.getTime();
            const timeDiffDays = timeDiffMs / (1000 * 60 * 60 * 24);
            const unitsForAvg = totalUnitsConsumed - lastConsumption.units;
            if (timeDiffDays > 0 && unitsForAvg > 0) { return { runRate: timeDiffDays / unitsForAvg }; }
            return { runRate: null }; 
        }

        function renderSummaryChart(items) {
            const chartData = items
                .filter(item => item.runRate && item.quantity > 0)
                .map(item => ({
                    name: item.name,
                    remainingDays: item.quantity * item.runRate
                }))
                .sort((a, b) => a.remainingDays - b.remainingDays); 

            if (summaryChart) {
                summaryChart.destroy();
            }

            if (chartData.length === 0) {
                ui.summaryChartContainer.classList.add('hidden');
                return;
            }
            ui.summaryChartContainer.classList.remove('hidden');

            const labels = chartData.map(d => d.name);
            const data = chartData.map(d => d.remainingDays);
            const colors = data.map(days => {
                if (days <= 14) return 'rgba(239, 68, 68, 0.8)';
                if (days <= 28) return 'rgba(245, 158, 11, 0.8)';
                return 'rgba(34, 197, 94, 0.8)';
            });

            summaryChart = new Chart(ui.summaryChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Days Remaining',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Est. ${context.raw.toFixed(1)} days remaining`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Estimated Days Remaining' }
                        }
                    }
                }
            });
        }


        function renderInventory(items) {
            ui.loadingDiv.classList.add('hidden');
            ui.inventoryList.innerHTML = ''; 

            const twoWeeksFromNow = new Date();
            twoWeeksFromNow.setDate(new Date().getDate() + 14);
            
            let lowStockCount = 0;

            if (items.length === 0) {
                ui.emptyStateDiv.classList.remove('hidden');
            } else {
                ui.emptyStateDiv.classList.add('hidden');
                items.forEach(item => {
                    const el = document.createElement('div');
                    
                    let depletionDate = null;
                    let depletionText = 'N/A';
                    let isRunningLow = false;

                    if (item.runRate && item.quantity > 0) {
                        depletionDate = new Date();
                        depletionDate.setDate(depletionDate.getDate() + (item.quantity * item.runRate));
                        depletionText = depletionDate.toLocaleDateString();
                        if (depletionDate <= twoWeeksFromNow) {
                           isRunningLow = true;
                           lowStockCount++;
                        }
                    } else if (item.runRate && item.quantity <= 0) {
                        depletionText = 'Empty';
                    }

                    el.className = `p-4 rounded-lg shadow-sm fade-in transition-colors ${isRunningLow ? 'bg-amber-50 border-2 border-amber-300' : 'bg-white'}`;
                    el.dataset.id = item.id;

                    el.innerHTML = `
                        <div class="flex items-center justify-between">
                             <p class="font-semibold text-lg flex items-center">
                                ${item.name}
                                ${isRunningLow ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2 text-amber-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>' : ''}
                            </p>
                            <button data-action="delete" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full flex items-center justify-center transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div class="item-quantity-display bg-slate-50 p-2 rounded-md text-center cursor-pointer hover:bg-slate-100 flex flex-col justify-center">
                                <p class="text-xs text-slate-500">Current Count</p>
                                <p class="text-2xl font-bold text-slate-800 item-quantity-value">${item.quantity}</p>
                            </div>
                            <div class="grid grid-cols-3 gap-1.5 text-sm">
                                <button data-action="increase-10" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 rounded-md">+10</button>
                                <button data-action="increase-1" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-md">+1</button>
                                <button data-action="increase-0.1" class="bg-blue-200 hover:bg-blue-300 text-blue-800 font-bold py-2 rounded-md">+0.1</button>
                                <button data-action="decrease-10" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 rounded-md">-10</button>
                                <button data-action="decrease-1" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 rounded-md">-1</button>
                                <button data-action="decrease-0.1" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 rounded-md">-0.1</button>
                            </div>
                        </div>
                        <div class="mt-4 pt-3 border-t border-slate-100 grid grid-cols-3 gap-2 text-center text-xs">
                             <div>
                                <p class="text-slate-500">Est. Run Rate</p>
                                <p class="font-medium">${item.runRate ? `${item.runRate.toFixed(1)} days/unit` : 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-slate-500">Est. Empty On</p>
                                <p class="font-medium">${depletionText}</p>
                            </div>
                            <div>
                                <button data-action="history" data-name="${item.name}" data-quantity="${item.quantity}" class="text-blue-600 hover:underline w-full h-full">View History</button>
                            </div>
                        </div>
                    `;
                    ui.inventoryList.appendChild(el);
                });
            }

            if (lowStockCount > 0) {
                ui.alertBannerText.textContent = `${lowStockCount} item${lowStockCount > 1 ? 's are' : ' is'} estimated to run out within two weeks.`;
                ui.alertBanner.classList.remove('hidden');
            } else {
                ui.alertBanner.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            ui.addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = e.target.itemName.value.trim();
                const quantity = parseFloat(e.target.itemQuantity.value);
                const duration = e.target.itemDuration.value.trim();
                if (name && !isNaN(quantity) && quantity >= 0) {
                    const docRef = await addDoc(inventoryCollection, { name, quantity, duration: duration || null });
                    await logChange(docRef.id, quantity, 0);
                    ui.addItemForm.reset();
                }
            });

            ui.inventoryList.addEventListener('click', (e) => {
                const target = e.target;
                const button = target.closest('button');
                const quantityDisplay = target.closest('.item-quantity-display');
                const itemElement = target.closest('[data-id]');
                if (!itemElement) return;
                const itemId = itemElement.dataset.id;
                
                if (button) {
                    const action = button.dataset.action;
                    if (action === 'increase-1') updateQuantity(itemId, 1);
                    else if (action === 'decrease-1') updateQuantity(itemId, -1);
                    else if (action === 'increase-10') updateQuantity(itemId, 10);
                    else if (action === 'decrease-10') updateQuantity(itemId, -10);
                    else if (action === 'increase-0.1') updateQuantity(itemId, 0.1);
                    else if (action === 'decrease-0.1') updateQuantity(itemId, -0.1);
                    else if (action === 'delete') deleteDoc(doc(db, inventoryCollection.path, itemId));
                    else if (action === 'history') showHistoryModal(itemId, button.dataset.name, button.dataset.quantity);
                } else if (quantityDisplay) {
                    handleQuantityOverwrite(quantityDisplay, itemId);
                }
            });

            ui.historyModal.closeBtn.addEventListener('click', () => ui.historyModal.el.classList.add('hidden'));
            ui.historyModal.el.addEventListener('click', (e) => {
                if (e.target === ui.historyModal.el) ui.historyModal.el.classList.add('hidden');
            });
        }
        
        function handleQuantityOverwrite(displayElement, itemId) {
            const valueElement = displayElement.querySelector('.item-quantity-value');
            const originalValue = valueElement.textContent;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.step = "0.1";
            input.className = 'no-spinner text-2xl font-bold text-slate-800 bg-transparent w-full text-center outline-none';
            input.value = originalValue;
            
            displayElement.replaceChild(input, valueElement);
            input.focus();
            input.select();
            
            const saveAndExit = () => {
                if (input.value !== originalValue) {
                    setQuantity(itemId, input.value);
                }
            };
            
            input.addEventListener('blur', saveAndExit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') { input.value = originalValue; input.blur(); }
            });
        }

        async function showHistoryModal(itemId, itemName, currentQuantity) {
            ui.historyModal.title.textContent = `History for ${itemName}`;
            
            if (historyChart) {
                historyChart.destroy();
                historyChart = null;
            }
            
            const canvasContainer = ui.historyModal.body;
            canvasContainer.innerHTML = ''; // Clear previous content

            const historyCol = collection(db, inventoryCollection.path, itemId, 'history');
            const q = query(historyCol, orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                canvasContainer.innerHTML = '<p class="text-center text-slate-500">No history recorded for this item yet.</p>';
            } else {
                const canvas = document.createElement('canvas');
                canvas.id = 'historyChart';
                canvasContainer.appendChild(canvas);

                const labels = [];
                const data = [];
                let runningQuantity = parseFloat(currentQuantity);
                labels.unshift('Now');
                data.unshift(runningQuantity);

                snapshot.docs.forEach(doc => {
                    const log = doc.data();
                    if (log.timestamp) {
                        const date = log.timestamp.toDate();
                        const prevQuantity = runningQuantity - log.change;
                        labels.unshift(date.toLocaleDateString());
                        data.unshift(prevQuantity);
                        runningQuantity = prevQuantity;
                    }
                });

                historyChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Stock Level',
                            data: data,
                            fill: true,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.1,
                            stepped: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            ui.historyModal.el.classList.remove('hidden');
        }
        
        main();
    </script>
</body>
</html>

